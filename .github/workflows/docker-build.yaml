---
name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      runtime_version:
        description: 'Specific runtime version to build (e.g., "16.4 LTS"). Leave empty to build all LTS runtimes.'
        required: false
        type: string
      image_type:
        description: 'Image type: "all" builds all images (minimal/standard/python + GPU variants), "cpu" builds CPU-only, "gpu" builds GPU images only'
        required: false
        type: choice
        options:
          - all
          - cpu
          - gpu
        default: all
      all_lts:
        description: 'Build all LTS versions (default: latest 2 LTS only)'
        required: false
        type: boolean
        default: false
      lts_count:
        description: 'Number of latest LTS versions to build (default: 2)'
        required: false
        type: number
        default: 2
      force_ubuntu_version:
        description: 'Force specific Ubuntu version for base images (e.g., "22.04" or "24.04")'
        required: false
        type: string
      include_ml_variants:
        description: 'Include ML runtime variants (default: false)'
        required: false
        type: boolean
        default: false
      push_images:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/dbx-runtime

jobs:
  generate-dockerfiles:
    name: Generate Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_gpu_images: ${{ steps.check-images.outputs.has_gpu }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Generate Dockerfiles
        run: |
          BUILD_CMD="poetry run dbx-container build --output-dir data"
          
          # Runtime version filter
          if [ -n "${{ github.event.inputs.runtime_version }}" ]; then
            BUILD_CMD="$BUILD_CMD --runtime-version '${{ github.event.inputs.runtime_version }}'"
          fi
          
          # LTS filtering
          if [ "${{ github.event.inputs.all_lts }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --all-lts"
          elif [ -n "${{ github.event.inputs.lts_count }}" ]; then
            BUILD_CMD="$BUILD_CMD --lts-count ${{ github.event.inputs.lts_count }}"
          fi
          
          # Image type filter
          if [ "${{ github.event.inputs.image_type }}" = "gpu" ]; then
            BUILD_CMD="$BUILD_CMD --image-type gpu"
          fi
          
          # Ubuntu version
          if [ -n "${{ github.event.inputs.force_ubuntu_version }}" ]; then
            BUILD_CMD="$BUILD_CMD --force-ubuntu-version '${{ github.event.inputs.force_ubuntu_version }}'"
          fi
          
          # ML variants
          if [ "${{ github.event.inputs.include_ml_variants }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --include-ml-variants"
          fi
          
          eval $BUILD_CMD

      - name: Generate build matrix
        id: set-matrix
        run: |
          MATRIX_CMD="poetry run dbx-container generate-matrix --only-lts"
          # Note: matrix generation is currently disabled as we build all images directly
          # This can be re-enabled if runtime-specific variations are needed
          # The matrix would handle python/python-gpu/standard/standard-gpu with different versions
          if [ "${{ github.event.inputs.image_type }}" = "gpu" ] || [ "${{ github.event.inputs.image_type }}" = "all" ]; then
            MATRIX_CMD="$MATRIX_CMD --image-type python-gpu"
          elif [ "${{ github.event.inputs.image_type }}" = "cpu" ]; then
            MATRIX_CMD="$MATRIX_CMD --image-type python"
          fi
          if [ -n "${{ github.event.inputs.lts_count }}" ] && [ "${{ github.event.inputs.all_lts }}" != "true" ]; then
            MATRIX_CMD="$MATRIX_CMD --latest-lts-count ${{ github.event.inputs.lts_count }}"
          fi
          MATRIX_JSON=$(eval $MATRIX_CMD)
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

      - name: Check for GPU images
        id: check-images
        run: |
          if [ -d "data/gpu" ] && [ "$(ls -A data/gpu 2>/dev/null)" ]; then
            echo "has_gpu=true" >> $GITHUB_OUTPUT
          else
            echo "has_gpu=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Dockerfiles
        uses: actions/upload-artifact@v5
        with:
          name: dockerfiles
          path: data/
          retention-days: 7

  # Build minimal image (base image for all variants)
  build-minimal:
    name: Build minimal
    needs: generate-dockerfiles
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push minimal image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/minimal/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:minimal
            dbx-runtime:minimal
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=minimal
          cache-to: type=gha,mode=max,scope=minimal
          outputs: type=docker

  # Build python image (depends on standard)
  build-python:
    name: Build python
    needs: [generate-dockerfiles, build-standard]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push python image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/python/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:python
            dbx-runtime:python
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=python
          cache-to: type=gha,mode=max,scope=python
          outputs: type=docker

  # Build standard image (depends on minimal)
  build-standard:
    name: Build standard
    needs: [generate-dockerfiles, build-minimal]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push standard image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/standard/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:standard
            dbx-runtime:standard
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=standard
          cache-to: type=gha,mode=max,scope=standard
          outputs: type=docker

  # Build GPU base image
  build-gpu:
    name: Build GPU base
    needs: generate-dockerfiles
    if: github.event.inputs.image_type != 'cpu'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push GPU base image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/gpu/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:gpu
            dbx-runtime:gpu
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=gpu
          cache-to: type=gha,mode=max,scope=gpu
          outputs: type=docker

  # Build minimal-gpu (depends on gpu base)
  build-minimal-gpu:
    name: Build minimal-gpu
    needs: [generate-dockerfiles, build-gpu]
    if: github.event.inputs.image_type != 'cpu'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push minimal-gpu image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/minimal-gpu/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:minimal-gpu
            dbx-runtime:minimal-gpu
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=minimal-gpu
          cache-to: type=gha,mode=max,scope=minimal-gpu
          outputs: type=docker

  # Build standard-gpu (depends on minimal-gpu)
  build-standard-gpu:
    name: Build standard-gpu
    needs: [generate-dockerfiles, build-minimal-gpu]
    if: github.event.inputs.image_type != 'cpu'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push standard-gpu image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/standard-gpu/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:standard-gpu
            dbx-runtime:standard-gpu
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=standard-gpu
          cache-to: type=gha,mode=max,scope=standard-gpu
          outputs: type=docker

  # Build python-gpu (depends on standard-gpu)
  build-python-gpu:
    name: Build python-gpu
    needs: [generate-dockerfiles, build-standard-gpu]
    if: github.event.inputs.image_type != 'cpu'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Dockerfiles
        uses: actions/download-artifact@v5
        with:
          name: dockerfiles
          path: data/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push python-gpu image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: data/python-gpu/latest/Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_images == 'true' || github.ref == 'refs/heads/main') }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:python-gpu
            dbx-runtime:python-gpu
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=python-gpu
          cache-to: type=gha,mode=max,scope=python-gpu
          outputs: type=docker
